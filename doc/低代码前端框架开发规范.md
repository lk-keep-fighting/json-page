# 基于 shadcn/ui 的低代码前端框架开发规范

本文档用于指导在本仓库内持续演进 JSON 驱动的低代码前端框架，尤其是表格型管理页面的开发、配置与扩展。请在新增功能或对接页面设计器时遵循以下约定。

---

## 1. 框架定位与技术栈

- **定位**：以数据表格为核心的后台页面引擎，通过 JSON 描述数据源、筛选、表格列与操作流程，兼顾可配置性与可扩展性。
- **技术栈**：React 18、Vite、TypeScript、Tailwind CSS、shadcn 风格组件。
- **运行方式**：所有页面均由配置在运行期渲染，无需编译阶段生成代码，可与远程配置或可视化设计器对接。

---

## 2. 渲染架构

1. **配置加载**：运行时获得 `AdminTablePageConfig`（可来源于本地文件、接口或设计器输出）。
2. **模型归一化**：通过 `src/lib/models/admin-table.ts` 将 `models` 字段与传统配置字段合并为标准结构。
3. **数据驱动**：`useDataSource` 根据归一化后的数据源、筛选、分页参数拉取/计算数据。
4. **组件渲染**：`src/components/blocks/admin-table/admin-table-block.tsx` 负责渲染筛选条、表格、分页与动作入口。
5. **动作执行**：`src/lib/actions/executor.ts` 解析模板占位符、执行 API/跳转，同时触发数据刷新等回调。

该流程确保配置层与渲染层解耦，方便在设计器、预览器与生产环境中复用。

---

## 3. AdminTablePageConfig 总览

`src/types/blocks/admin-table.ts` 定义了核心类型。顶层配置结构如下：

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `type` | 固定为 `"admin-table"` | 标识区块类型 |
| `title` / `description` | `string` | （可选）页面标题与描述，渲染在卡片头部 |
| `dataSource` | `DataSourceConfig` | 兼容模式下的数据源定义，若使用 `models.view` 可省略 |
| `filters` | `FilterConfig[]` | 兼容模式下的筛选器定义，与 `models.filterForms` 合并 |
| `headerActions` | `GlobalActionConfig[]` | 顶部操作按钮，与模型层合并 |
| `table` | `TableConfig` | 表格列、分页、操作配置，与 `models.view/operations` 合并 |
| `models` | `AdminTableModelsConfig` | 模型化配置层，详见下一节 |

> **归一化策略**：若同时存在兼容模式字段与模型字段，归一化时以模型为主，兼容字段作为补充：
> - 同 ID 的筛选/操作不会被重复添加。
> - 未在模型中声明的数据源/列会回落到兼容字段。
> - `models.view.columns` 为空时会使用 `table.columns`。

---

## 4. 模型驱动配置

### 4.1 AdminTableModelsConfig

```ts
interface AdminTableModelsConfig {
  view: TableViewModel;
  filterForms?: FilterFormModel[];
  submissionForms?: SubmissionFormModel[];
  operations?: DataOperationModel[];
}
```

- **view**：描述主表格视图（数据源、列、分页、空状态）。
- **filterForms**：包含一个或多个筛选表单模型，归一化后会平铺为筛选条内容。
- **submissionForms**：声明可复用的弹窗表单，与操作通过 `formRef` 关联。
- **operations**：声明全局 / 行级 / 批量操作，支持引用 `submissionForms`。

### 4.2 TableViewModel

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `type` | 固定为 `"table-view"` |
| `dataSource` | `DataSourceConfig` | 静态或远程数据源 |
| `columns` | `TableColumnConfig[]` | 表格列定义，详见第 6 节 |
| `selectable` | `boolean` | 是否允许勾选，默认为 `false` |
| `pagination` | `PaginationConfig` | 分页设置；`defaultPageSize` 决定初始每页数量 |
| `emptyState` | `{ title: string; description?: string }` | 无数据时的展示 |

### 4.3 FilterFormModel

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `id` | `string` | 筛选表单唯一标识 |
| `type` | 固定为 `"filter-form"` |
| `filters` | `FilterConfig[]` | 筛选项集合，详见第 5 节 |

### 4.4 SubmissionFormModel

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `id` | `string` | 表单模型唯一标识 |
| `type` | 固定为 `"submission-form"` |
| `form` | `ActionFormConfig` | 弹窗表单配置，详见第 8 节 |

### 4.5 DataOperationModel

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `id` | `string` | 操作唯一标识 |
| `type` | 固定为 `"data-operation"` |
| `scope` | `"global" \| "row" \| "bulk"` | 作用范围（页面、单行、多行） |
| `label` | `string` | 操作文案 |
| `intent` | `ActionIntent` | 对应按钮视觉风格（shadcn 语义） |
| `icon` | `string` | （可选）图标名称，设计器阶段可输出字符串再由前端映射 |
| `confirm` | `ActionConfirmation` | （可选）确认弹窗配置 |
| `behavior` | `ActionBehavior` | 行为定义（API 或外链），详见第 7 节 |
| `form` | `ActionFormConfig` | （可选）内联表单，优先级高于 `formRef` |
| `formRef` | `string` | （可选）引用 `submissionForms` 中的表单 |
| `requiresSelection` | `boolean` | 批量操作是否强制选择数据，默认为 `true` |

---

## 5. 筛选器规范（FilterConfig）

筛选项用于构造筛选条与数据源查询参数：

| 字段 | 说明 |
| ---- | ---- |
| `id` | 唯一标识，同时作为筛选状态的键 |
| `label` | 展示名称 |
| `field` | 对应数据源字段，用于本地过滤与远程查询映射 |
| `type` | `"text" | "number" | "select" | "boolean" | "date-range"` |
| `placeholder` | 输入提示 |
| `defaultValue` | 初始化值，支持字符串、数值、布尔、`{ from, to }` 范围 |
| `options` | `type = "select"` 时的可选项 |
| `trueLabel` / `falseLabel` | `type = "boolean"` 时的显示文本 |

> `defaultValue` 会在初始渲染与“重置”操作时写入筛选状态。布尔筛选默认展示 `全部/是/否`；日期区间默认使用 `{ from: "", to: "" }`。

---

## 6. 表格列规范（TableColumnConfig）

| 字段 | 说明 |
| ---- | ---- |
| `id` | 唯一标识 |
| `label` | 列头名称 |
| `dataIndex` | 读取行数据的字段，支持嵌套路径（`user.name`） |
| `width` | 数值或字符串宽度 |
| `align` | `"left" | "center" | "right"` |
| `sortable` | 是否允许排序，排序状态通过 `useDataSource` 传递，需数据源支持 |
| `renderType` | `"text" | "badge" | "boolean" | "date" | "currency" | "custom"` |
| `valueMapping` | `renderType = "badge"` 时映射标签与样式 |
| `currency` | 货币展示配置（货币代码、locale、小数位） |
| `dateFormat` | 日期展示配置（`Intl.DateTimeFormatOptions`） |

表格级别配置（`TableConfig`）：
- `selectable`：开启后可勾选行。
- `rowActions` / `bulkActions`：兼容模式定义的行/批量操作，归一化后与 `models.operations` 合并。
- `pagination`：`{ defaultPageSize?: number; pageSizeOptions?: number[] }`。
- `emptyState`：自定义无数据时的提示。

---

## 7. 行为与动作执行

`ActionBehavior` 支持两种类型：

1. **API 调用 (`type = "api"`)**
   - `method`：`GET | POST | PUT | PATCH | DELETE`
   - `endpoint`：可包含模板占位符的请求地址
   - `headers`：自定义请求头
   - `query`：保留字段，当前版本主要依赖模板与 `requestBody`
   - `bodyTemplate`：JSON 模板，使用模板占位符动态生成请求体
   - `successMessage` / `errorMessage`：执行后的提示文案（目前以 `console.info` 输出，可与通知系统集成）

2. **外链跳转 (`type = "link"`)**
   - `url`：可带模板占位符的目标地址
  - `target`：`"_blank" | "_self"`

动作执行流程：
1. 触发前处理 `confirm`，若用户取消则终止。
2. 通过 `buildActionTemplateContext` 构造模板上下文，替换 `endpoint`、`url`、`bodyTemplate` 等字段。
3. 执行 API 或跳转行为。
4. 若行为类型为 API，返回成功后触发回调（如刷新数据源）。

---

## 8. 提交表单规范（ActionFormConfig）

弹窗表单用于在执行操作前收集额外信息：

| 字段 | 说明 |
| ---- | ---- |
| `title` / `description` | 弹窗标题与描述 |
| `submitLabel` / `cancelLabel` | 操作按钮文案 |
| `fields` | 表单字段数组 |

表单字段支持以下类型：

| `type` | 字段 | 说明 |
| ------ | ---- | ---- |
| `"text"` | `placeholder`、`maxLength` | 普通文本输入 |
| `"number"` | `min`、`max`、`step` | 数值输入 |
| `"textarea"` | `rows`、`maxLength` | 多行文本 |
| `"select"` | `options` | 下拉选择，与筛选器选项结构一致 |

字段可声明 `required` 与 `defaultValue`。提交时的值会以 `formValues` 注入模板上下文。

---

## 9. 数据源规范（DataSourceConfig）

### 9.1 静态数据源 (`type = "static"`)

- `data`：数组，包含所有字段。
- 支持本地筛选、排序与分页（在前端完成）。

### 9.2 远程数据源 (`type = "remote"`)

| 字段 | 说明 |
| ---- | ---- |
| `endpoint` | 请求地址，可带占位符 |
| `method` | `"GET" | "POST"`，默认 `GET` |
| `headers` | 可选请求头 |
| `requestBody` | 非 `GET` 请求时的固定请求体（会与分页、筛选、排序信息合并） |
| `pagination` | `{ pageParam?: string; pageSizeParam?: string }`，默认 `page` 与 `pageSize` |
| `queryMapping` | 将筛选器 ID 映射成请求参数名；日期区间会自动拼接 `From`/`To` 后缀 |
| `responseMapping` | 指定响应中数据与总数的路径（默认 `data` 与 `total`） |

请求参数约定：
- `page` / `pageSize`：默认会作为查询字符串或请求体字段发送。
- `sortField` / `sortDirection`：若用户对列排序会自动加入。
- 筛选器值：按 `queryMapping` 或原 ID 注入查询字符串。日期区间默认生成 `xxxFrom`/`xxxTo`。

---

## 10. 模板占位符与上下文

模板占位符由 `buildActionTemplateContext` 提供，支持以下路径：

| 占位符 | 说明 |
| ------ | ---- |
| `{{row}}` / `{{row.xxx}}` | 当前行数据 |
| `{{rowId}}` | 行主键（`id`/`key`/`uuid`） |
| `{{rows}}` | 批量操作选中的行数组 |
| `{{rowIds}}` | 批量操作选中的主键数组 |
| `{{filters.xxx}}` | 当前筛选条件 |
| `{{formValues.xxx}}` / `{{form.xxx}}` | 表单提交值 |

在 API `bodyTemplate` 中可嵌套对象或数组，`resolveTemplateValue` 会深度遍历并替换字符串模板。

---

## 11. 渲染与交互流程详解

1. **初始化**：
   - 计算筛选器初始值（布尔型默认 `all`，日期型默认空范围或 `defaultValue`）。
   - 依据 `table.pagination.defaultPageSize` 设置初始分页。
2. **数据加载**：
   - 每当筛选、分页、排序或数据源配置变化时调用 `useDataSource`。
   - 静态数据在前端过滤；远程数据通过 `fetch` 请求。
3. **用户交互**：
   - 筛选、分页、排序会更新状态并重新请求数据。
   - 勾选行会维护 `selectedRowIds`，批量操作依赖该状态。
4. **动作执行**：
   - 行为执行成功后会自动 `refetch()` 以同步数据。
   - 若动作配置 `form`/`formRef`，会弹出 `ActionFormDialog` 收集参数。

---

## 12. 开发约定与扩展指南

- **类型优先**：新增能力时先扩展 `src/types/blocks/admin-table.ts`，再实现渲染与归一化逻辑，确保类型与运行时一致。
- **归一化策略**：`normalizeAdminTableConfig` 是模型合并的唯一入口，扩展时需保证：
  - 不破坏现有兼容字段。
  - 只在此处处理 ID 去重、表单引用解析等逻辑。
- **组件拆分**：通用 UI 与交互放在 `src/components/blocks/shared/data-table/` 中，避免与具体业务耦合。
- **模板安全**：`resolveTemplateValue` 仅支持字符串模板，不允许执行 JS 表达式，后续如需扩展需评估安全性。
- **国际化/多语言**：文本建议由配置提供，组件层不内置翻译逻辑。
- **错误处理**：远程请求失败会回传 `error`，渲染端需保证兜底提示。

---

## 13. 页面设计器对接建议

- **Schema 导出**：以 `AdminTablePageConfig` 为核心 Schema，可直接供设计器生成 JSON。
- **组件元信息**：设计器应维护可选 `renderType`、`intent`、筛选类型等枚举，并在导出时保证与类型定义一致。
- **默认策略**：设计器侧可读取 `defaultValue` 以生成初始预览；若未提供，前端会自动填充空值逻辑。
- **表单复用**：推荐通过 `submissionForms` 管理表单片段，操作仅保存 `formRef`，便于统一维护。
- **校验提示**：提交给渲染器的配置需至少包含 `view.columns`、有效的数据源以及一个操作或列，设计器应在生成时校验。

---

## 14. 示例与参考

- `src/config/example.ts`：包含 `exampleAdminConfig`（兼容模式）与 `exampleModelDrivenConfig`（模型驱动）两个完整示例。
- `src/components/blocks/admin-table/admin-table-block.tsx`：查看表格区块的具体渲染与交互实现。
- `src/lib/models/admin-table.ts`：理解模型归一化与操作表单解析逻辑。
- `src/lib/data-sources/use-data-source.ts`：了解本地/远程数据处理流程。

> 建议在扩展前先阅读上述文件，确保新功能与现有架构一致。

---

## 15. 术语对照表

| 术语 | 说明 |
| ---- | ---- |
| AdminTablePageConfig | 页面级配置入口 |
| TableViewModel | 表格视图模型，定义列与数据源 |
| FilterFormModel | 筛选表单模型，转换为筛选条 |
| SubmissionFormModel | 弹窗表单模型，可被多个操作复用 |
| DataOperationModel | 数据操作模型，支持全局/行/批量 |
| ActionBehavior | 操作行为，当前支持 API 与外链 |
| Template Context | 模板上下文，提供占位符所需数据 |

---

如需在此基础上扩展更多区块类型或可视化能力，请保持同样的模型化思路：先定义类型与模型，再实现归一化与渲染，确保设计器与运行时的一致性。
